<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - √âchec Derni√®re √ânigme</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .test-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .problem {
            background: rgba(220, 53, 69, 0.2);
            border-left: 4px solid #dc3545;
        }
        .solution {
            background: rgba(40, 167, 69, 0.2);
            border-left: 4px solid #28a745;
        }
        .test-case {
            background: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
        }
        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .code-block {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .highlight {
            background: rgba(255, 255, 0, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Test - Correction √âchec Derni√®re √ânigme</h1>
        <p><strong>Date:</strong> <span id="currentDate"></span></p>
        <p><strong>Probl√®me identifi√©:</strong> Quand on rate la derni√®re √©nigme, le quiz final se d√©clenche automatiquement sans attendre la prise de photo.</p>
    </div>

    <div class="test-section problem">
        <h2>‚ùå Probl√®me Original</h2>
        <p><strong>Comportement incorrect:</strong></p>
        <ul>
            <li>√âchec sur la derni√®re √©nigme ‚Üí Quiz final imm√©diat</li>
            <li>Pas d'attente pour la prise de photo</li>
            <li>L'√©nigme ne passe pas en statut "failed" correctement</li>
            <li>Comportement diff√©rent entre succ√®s et √©chec sur la derni√®re √©nigme</li>
        </ul>
        
        <h3>üîç Cause du probl√®me</h3>
        <div class="code-block">
            <code>
// Ancienne logique dans App.jsx - solveEnigma()
if (isLastEnigma && isCorrect) {
    // Seulement pour les SUCC√àS
    if (lastEnigmaHasPhoto) {
        updatedPlayer.pendingVictory = true;
    }
} else if (totalProcessed === currentEnigmas.length) {
    // √âCHECS tombaient ici ‚Üí Quiz imm√©diat
    const validation = isGameValid(updatedPlayer);
    if (!quizCompleted) {
        setShowMandatoryQuiz(true); // ‚ùå Quiz imm√©diat
    }
}
            </code>
        </div>
    </div>

    <div class="test-section solution">
        <h2>‚úÖ Solution Impl√©ment√©e</h2>
        <p><strong>Comportement corrig√©:</strong></p>
        <ul>
            <li>‚úÖ √âchec sur la derni√®re √©nigme ‚Üí Attente photo si <code>hasPhoto = true</code></li>
            <li>‚úÖ M√™me logique pour succ√®s et √©chec</li>
            <li>‚úÖ <code>pendingVictory</code> d√©fini pour les deux cas</li>
            <li>‚úÖ Quiz d√©clench√© apr√®s photo ou bouton "Continuer sans photo"</li>
        </ul>
        
        <h3>üîß Modifications apport√©es</h3>
        
        <h4>1. Logique unifi√©e dans <code>solveEnigma()</code></h4>
        <div class="code-block">
            <code>
// Nouvelle logique - traite succ√®s ET √©checs
if (isLastEnigma) {
    console.log("üèÅ Derni√®re √©nigme trait√©e !", isCorrect ? "‚úÖ R√©ussie" : "‚ùå √âchou√©e");
    
    if (lastEnigmaHasPhoto) {
        // Pour SUCC√àS ET √âCHECS avec photo
        updatedPlayer.pendingVictory = true; // Flag pour fin de jeu en attente
    } else {
        // Fin de jeu imm√©diate si pas de photo
        const validation = isGameValid(updatedPlayer, currentEnigmas.length);
        if (validation.isValid) {
            if (!quizCompleted) {
                setShowMandatoryQuiz(true);
                return isCorrect;
            }
            setGameState("victory");
        } else {
            setGameState("failure");
        }
    }
}
            </code>
        </div>
        
        <h4>2. Fonction <code>triggerVictoryAfterPhoto()</code> mise √† jour</h4>
        <div class="code-block">
            <code>
// Renomm√©e en triggerEndGameAfterPhoto conceptuellement
const triggerVictoryAfterPhoto = () => {
    console.log("üéâ D√©clenchement fin de jeu apr√®s photo");
    
    // Utilise le bon nombre total d'√©nigmas
    const validation = isGameValid(currentPlayer, currentEnigmas.length);
    
    if (validation.isValid) {
        if (!quizCompleted) {
            setShowMandatoryQuiz(true); // Quiz apr√®s photo
            return;
        }
        setGameState("victory");
    } else {
        setGameState("failure");
    }
};
            </code>
        </div>
    </div>

    <div class="test-section test-case">
        <h2>üß™ Cas de Test</h2>
        
        <h3>Sc√©nario 1: √âchec derni√®re √©nigme AVEC photo</h3>
        <ol>
            <li>Jouer jusqu'√† la derni√®re √©nigme</li>
            <li>Donner une mauvaise r√©ponse</li>
            <li><span class="highlight">V√©rifier:</span> PhotoSection s'affiche avec message d'√©chec</li>
            <li><span class="highlight">V√©rifier:</span> Boutons "Prendre photo" et "Continuer sans photo" disponibles</li>
            <li>Cliquer "Prendre photo" ou "Continuer sans photo"</li>
            <li><span class="highlight">V√©rifier:</span> Quiz final se d√©clenche APR√àS l'action</li>
        </ol>
        
        <h3>Sc√©nario 2: √âchec derni√®re √©nigme SANS photo</h3>
        <ol>
            <li>Jouer jusqu'√† la derni√®re √©nigme (sans photo)</li>
            <li>Donner une mauvaise r√©ponse</li>
            <li><span class="highlight">V√©rifier:</span> Quiz final se d√©clenche imm√©diatement</li>
        </ol>
        
        <h3>Sc√©nario 3: Succ√®s derni√®re √©nigme AVEC photo</h3>
        <ol>
            <li>Jouer jusqu'√† la derni√®re √©nigme</li>
            <li>Donner la bonne r√©ponse</li>
            <li><span class="highlight">V√©rifier:</span> PhotoSection s'affiche avec message de succ√®s</li>
            <li><span class="highlight">V√©rifier:</span> M√™me comportement qu'en cas d'√©chec</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>üìã Checklist de Validation</h2>
        <ul>
            <li>‚òê √âchec derni√®re √©nigme ‚Üí PhotoSection affich√© si <code>hasPhoto = true</code></li>
            <li>‚òê Succ√®s derni√®re √©nigme ‚Üí PhotoSection affich√© si <code>hasPhoto = true</code></li>
            <li>‚òê Quiz final d√©clench√© APR√àS photo/bouton, pas avant</li>
            <li>‚òê <code>pendingVictory</code> d√©fini pour succ√®s ET √©checs</li>
            <li>‚òê √ânigme √©chou√©e ajout√©e √† <code>player.failed</code></li>
            <li>‚òê Comportement identique entre succ√®s et √©chec</li>
            <li>‚òê Pas de r√©gression sur les √©nigmes non-finales</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üîç Points de V√©rification Technique</h2>
        <ul>
            <li><strong>App.jsx ligne ~742:</strong> <code>if (isLastEnigma)</code> sans condition <code>&& isCorrect</code></li>
            <li><strong>App.jsx ligne ~754:</strong> <code>updatedPlayer.pendingVictory = true</code> pour succ√®s ET √©checs</li>
            <li><strong>App.jsx ligne ~957:</strong> <code>isGameValid(currentPlayer, currentEnigmas.length)</code></li>
            <li><strong>EnigmaCard.jsx ligne ~290:</strong> PhotoSection affich√© pour <code>isSuccess || isFailure</code></li>
            <li><strong>PhotoSection.jsx:</strong> Messages adapt√©s pour succ√®s et √©checs</li>
        </ul>
    </div>

    <script>
        // Afficher la date actuelle
        document.getElementById('currentDate').textContent = new Date().toLocaleString('fr-FR');
        
        // Ajouter des interactions pour les checkboxes
        document.querySelectorAll('li').forEach(li => {
            if (li.textContent.includes('‚òê')) {
                li.style.cursor = 'pointer';
                li.addEventListener('click', function() {
                    if (this.textContent.includes('‚òê')) {
                        this.innerHTML = this.innerHTML.replace('‚òê', '‚úÖ');
                        this.style.color = '#28a745';
                    } else if (this.textContent.includes('‚úÖ')) {
                        this.innerHTML = this.innerHTML.replace('‚úÖ', '‚òê');
                        this.style.color = '';
                    }
                });
            }
        });
    </script>
</body>
</html>